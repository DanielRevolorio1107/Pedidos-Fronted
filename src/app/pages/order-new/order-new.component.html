<mat-card>
  <mat-card-title>Nuevo pedido</mat-card-title>
  <mat-card-subtitle>
    <a routerLink="/orders" mat-button color="primary"><mat-icon>arrow_back</mat-icon> Volver</a>
  </mat-card-subtitle>

  <mat-card-content>
    <div *ngIf="loading">Cargando…</div>
    <div *ngIf="!loading && error" class="err">{{ error }}</div>

    <form [formGroup]="form" (ngSubmit)="save()" *ngIf="!loading" class="form-grid">
      <mat-form-field appearance="outline">
        <mat-label>Número</mat-label>
        <input matInput type="number" formControlName="number" placeholder="Ej. 1001">
        <mat-error *ngIf="f.number.touched && f.number.invalid">Ingresa un número mayor a 0.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Cliente</mat-label>
        <mat-select formControlName="personId">
          <mat-option [value]="null" disabled>— Selecciona cliente —</mat-option>
          <mat-option *ngFor="let p of persons" [value]="p.id">
            {{ p.fullName || (p.firstName + ' ' + p.lastName) }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="f.personId.touched && f.personId.invalid">Selecciona un cliente.</mat-error>
      </mat-form-field>

      <div class="spacer"></div>

      <!-- Agregar ítem -->
      <h3 class="section">Agregar ítem</h3>

      <div [formGroup]="detailForm" class="detail-grid">
        <mat-form-field appearance="outline">
          <mat-label>Ítem</mat-label>
          <mat-select formControlName="itemId">
            <mat-option [value]="null" disabled>— Seleccionar —</mat-option>
            <mat-option *ngFor="let it of items" [value]="it.id">
              {{ it.name }} ({{ it.price | number:'1.2-2' }})
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" min="1" formControlName="quantity">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Precio</mat-label>
          <input matInput type="number" [value]="priceSig()" disabled>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Total línea</mat-label>
          <input matInput type="number" [value]="lineTotalSig()" disabled>
        </mat-form-field>

        <div class="actions-right">
          <button mat-raised-button color="primary" type="button" (click)="addDetail()" [disabled]="detailForm.invalid">
            <mat-icon>add</mat-icon> Agregar
          </button>
        </div>
      </div>

      <!-- Carrito -->
      <div *ngIf="pending.length; else emptyCart" class="table-wrap">
        <table class="mat-elevation-z2 material-table">
          <thead>
            <tr>
              <th>Item</th>
              <th style="width:220px">Cantidad</th>
              <th class="num">Precio</th>
              <th class="num">Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of pending">
              <td>{{ d.itemName }}</td>
              <td>
                <div class="qty">
                  <button mat-stroked-button color="primary" type="button" (click)="dec(d.itemId)">−</button>
                  <input class="qty-input" type="number" [value]="d.quantity" min="1"
                         (change)="updateQty(d.itemId, $any($event.target).value)">
                  <button mat-stroked-button color="primary" type="button" (click)="inc(d.itemId)">+</button>
                </div>
              </td>
              <td class="num">{{ d.price | number:'1.2-2' }}</td>
              <td class="num">{{ d.total | number:'1.2-2' }}</td>
              <td class="right">
                <button mat-button color="warn" type="button" (click)="removeDetail(d.itemId)">
                  <mat-icon>delete</mat-icon> Quitar
                </button>
              </td>
            </tr>
            <tr>
              <td colspan="3" class="num"><b>Total</b></td>
              <td class="num"><b>{{ grandTotal() | number:'1.2-2' }}</b></td>
              <td class="right">
                <button mat-stroked-button type="button" (click)="clearPending()">Vaciar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #emptyCart>
        <p class="muted">Aún no agregaste ítems.</p>
      </ng-template>

      <div class="form-actions">
        <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || saving || pending.length===0">
          Guardar
        </button>
        <button mat-button type="button" [routerLink]="'/orders'">Cancelar</button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
