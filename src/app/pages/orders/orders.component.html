<mat-card>
  <mat-card-title>Pedidos</mat-card-title>
  <mat-card-subtitle *ngIf="!loading && !error">
    Total: {{ orders.length }} pedido{{ orders.length === 1 ? '' : 's' }}
  </mat-card-subtitle>

  <mat-card-content>
    <div *ngIf="loading">Cargando…</div>
    <div *ngIf="!loading && error" class="err">{{ error }}</div>

    <table class="material-table" *ngIf="!loading && !error && orders.length">
      <thead>
        <tr>
          <th>ID</th>
          <th>No.</th>
          <th>Cliente</th>
          <th>Creado</th>
          <th class="num"># Detalles</th>
          <th class="right">Acción</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let o of orders; trackBy: trackById">
          <tr>
            <td>{{ o.id }}</td>
            <td>{{ o.number }}</td>
            <td>{{ o.person?.firstName }} {{ o.person?.lastName }}</td>
            <td>{{ o.createdAt ? (o.createdAt | date:'short') : '—' }}</td>
            <td class="num">
              {{ o.details?.length ? o.details.length : '—' }}
            </td>
            <td class="right">
              <button mat-stroked-button color="primary" (click)="toggle(o.id)" [disabled]="!o.details?.length">
                {{ isOpen(o.id) ? 'Ocultar' : 'Ver' }}
              </button>
            </td>
          </tr>

          <!-- Fila expandida con detalles -->
          <tr *ngIf="isOpen(o.id)">
            <td colspan="6" class="expand-cell">
              <div class="subcard mat-elevation-z2">
                <table class="subtable">
                  <thead>
                    <tr>
                      <th>ID Detalle</th>
                      <th>Item</th>
                      <th class="num">Cantidad</th>
                      <th class="num">Precio</th>
                      <th class="num">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let d of o.details">
                      <td>{{ d.id }}</td>
                      <td>
                        {{ d.itemId }}
                        <ng-container *ngIf="d['itemName']"> - {{ d['itemName'] }}</ng-container>
                      </td>
                      <td class="num">{{ d.quantity }}</td>
                      <td class="num">{{ d.price | number:'1.2-2' }}</td>
                      <td class="num">{{ d.total | number:'1.2-2' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>

    <p *ngIf="!loading && !error && !orders.length" class="muted">No hay pedidos.</p>
  </mat-card-content>
</mat-card>
